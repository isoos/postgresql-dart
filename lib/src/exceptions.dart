import 'dart:io';

import 'package:collection/collection.dart';
import 'package:meta/meta.dart';

import 'server_messages.dart';
import 'types.dart';

/// Exception thrown by the package (client or server side).
class PgException implements Exception {
  /// The severity of the exception.
  final Severity severity;

  /// A message indicating the error.
  final String message;

  PgException(
    this.message, {
    this.severity = Severity.error,
  });

  @override
  String toString() => '$severity $message';
}

/// Exception thrown when server certificate validate failed.
class BadCertificateException extends PgException {
  final X509Certificate certificate;

  BadCertificateException(this.certificate)
      : super('Bad server certificate.', severity: Severity.fatal);
}

/// Exception thrown by the server.
class PgServerException extends PgException {
  /// An index into an executed query string where an error occurred, if by provided by the database.
  final int? position;

  /// An index into a query string generated by the database, if provided.
  final int? internalPosition;

  final int? lineNumber;

  /// The PostgreSQL error code.
  ///
  /// May be null if the exception was not generated by the database.
  final String? code;

  /// Additional details if provided by the database.
  final String? detail;

  /// A hint on how to remedy an error, if provided by the database.
  final String? hint;

  final String? internalQuery;
  final String? trace;

  final String? schemaName;
  final String? tableName;
  final String? columnName;
  final String? dataTypeName;
  final String? constraintName;
  final String? fileName;
  final String? routineName;

  PgServerException._(
    super.message, {
    required super.severity,
    this.position,
    this.internalPosition,
    this.lineNumber,
    this.code,
    this.detail,
    this.hint,
    this.internalQuery,
    this.trace,
    this.schemaName,
    this.tableName,
    this.columnName,
    this.dataTypeName,
    this.constraintName,
    this.fileName,
    this.routineName,
  });

  @internal
  PgServerException(
    String message, {
    Severity? severity,
  }) : this._(
          message,
          severity: severity ?? Severity.error,
        );

  @internal
  factory PgServerException.fromFields(List<ErrorField> errorFields) {
    String? findString(int identifier) => errorFields
        .firstWhereOrNull((ErrorField e) => e.identificationToken == identifier)
        ?.text;

    int? findInt(int identifier) {
      final i = findString(identifier);
      return i == null ? null : int.parse(i);
    }

    return PgServerException._(
      findString(ErrorField.MessageIdentifier) ?? 'Server error.',
      severity: ErrorField.severityFromString(
        findString(ErrorField.SeverityIdentifier),
      ),
      position: findInt(ErrorField.PositionIdentifier),
      internalPosition: findInt(ErrorField.InternalPositionIdentifier),
      lineNumber: findInt(ErrorField.LineIdentifier),
      code: findString(ErrorField.CodeIdentifier),
      detail: findString(ErrorField.DetailIdentifier),
      hint: findString(ErrorField.HintIdentifier),
      internalQuery: findString(ErrorField.InternalQueryIdentifier),
      trace: findString(ErrorField.WhereIdentifier),
      schemaName: findString(ErrorField.SchemaIdentifier),
      tableName: findString(ErrorField.TableIdentifier),
      columnName: findString(ErrorField.ColumnIdentifier),
      dataTypeName: findString(ErrorField.DataTypeIdentifier),
      constraintName: findString(ErrorField.ConstraintIdentifier),
      fileName: findString(ErrorField.FileIdentifier),
      routineName: findString(ErrorField.RoutineIdentifier),
    );
  }

  @override
  String toString() {
    final buff = StringBuffer('$severity $code: $message');
    if (detail != null) {
      buff.write(' detail: $detail');
    }
    if (hint != null) {
      buff.write(' hint: $hint');
    }
    if (tableName != null) {
      buff.write(' table: $tableName');
    }
    if (columnName != null) {
      buff.write(' column: $columnName');
    }
    if (constraintName != null) {
      buff.write(' constraint $constraintName');
    }
    return buff.toString();
  }
}
